// IntelligentSPM Database Schema
// Neon PostgreSQL with Prisma 7

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================================
// COMPANY & USER MANAGEMENT
// ============================================================================

model Company {
  id            String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  domain        String   @unique // e.g., "acme.com"
  name          String?
  analysisCount Int      @default(0) @map("analysis_count")
  maxAnalyses   Int      @default(3) @map("max_analyses")
  createdAt     DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt     DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  users User[]

  @@index([domain])
  @@map("companies")
}

model User {
  id           String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  email        String    @unique
  name         String?
  linkedinId   String?   @unique @map("linkedin_id")
  linkedinUrl  String?   @map("linkedin_url")
  linkedinData Json?     @map("linkedin_data") // Store profile info
  companyId    String    @map("company_id") @db.Uuid
  company      Company   @relation(fields: [companyId], references: [id])
  verifiedAt   DateTime? @map("verified_at") @db.Timestamptz(6)
  analysisUsed Boolean   @default(false) @map("analysis_used")
  createdAt    DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt    DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)

  analyses Analysis[]
  sessions Session[]
  accounts Account[]

  @@index([email])
  @@index([companyId])
  @@index([linkedinId])
  @@map("users")
}

// ============================================================================
// NEXTAUTH MODELS
// ============================================================================

model Account {
  id                String  @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId            String  @map("user_id") @db.Uuid
  type              String
  provider          String
  providerAccountId String  @map("provider_account_id")
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  sessionToken String   @unique @map("session_token")
  userId       String   @map("user_id") @db.Uuid
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("sessions")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

// ============================================================================
// ANALYSIS TRACKING
// ============================================================================

model Analysis {
  id     String @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId String @map("user_id") @db.Uuid
  user   User   @relation(fields: [userId], references: [id])

  // Analysis type: "governance" | "comp-plan" | "spm-quiz" | "askspm"
  type String

  // Results
  score           Int?
  tierResult      String? @map("tier_result") // "Foundational" | "Operational" | "Optimized" | "Advanced"
  coveragePercent Int?    @map("coverage_percent")

  // Raw data
  rawInput  Json? @map("raw_input") // Document text or quiz answers
  rawOutput Json  @map("raw_output") // Full API response

  // Metadata
  ipAddress String? @map("ip_address")
  userAgent String? @map("user_agent")

  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  @@index([userId])
  @@index([type])
  @@index([createdAt])
  @@map("analyses")
}

// ============================================================================
// AUDIT LOG
// ============================================================================

model AuditLog {
  id        String @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  eventType String @map("event_type") // "auth.login" | "auth.linkedin" | "analysis.run" | "analysis.blocked"
  severity  String @default("info") // "info" | "warn" | "error"
  message   String

  // Actor info
  userId        String? @map("user_id") @db.Uuid
  email         String?
  companyDomain String? @map("company_domain")

  // Request info
  ipAddress String? @map("ip_address")
  userAgent String? @map("user_agent")

  // Additional context
  metadata Json?

  occurredAt DateTime @default(now()) @map("occurred_at") @db.Timestamptz(6)

  @@index([eventType])
  @@index([userId])
  @@index([occurredAt])
  @@map("audit_logs")
}

// ============================================================================
// KNOWLEDGE BASE (RAG) - Todd's 929 SPM Cards
// ============================================================================

model KnowledgeChunk {
  id      String @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  cardId  String @map("card_id") // Original card ID from spm-kb-cards.json
  keyword String // Primary keyword
  content String @db.Text // Full chunk text

  // Metadata
  pillar   String // e.g., "SALES_PLANNING", "ICM"
  category String // e.g., "Sales Data", "Quota Management"
  cardType String   @map("card_type") // e.g., "concept", "practice"
  tags     String[] // Array of tags

  // Vector embedding (pgvector)
  // Stored as vector(768) for Ollama nomic-embed-text
  embedding      Unsupported("vector(768)")?
  embeddingModel String?                     @map("embedding_model")

  // Content hash for idempotent ingestion
  contentHash String @unique @map("content_hash")

  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  @@index([cardId])
  @@index([pillar])
  @@index([keyword])
  @@map("knowledge_chunks")
}

model AskQuery {
  id        String @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  queryText String @map("query_text") @db.Text

  // Results
  responseText  String? @map("response_text") @db.Text
  topK          Int     @default(5) @map("top_k")
  resultCount   Int?    @map("result_count")
  matchedChunks Json?   @map("matched_chunks") // Array of {chunkId, score}

  // Model info
  embeddingModel String? @map("embedding_model")
  llmModel       String? @map("llm_model")
  llmProvider    String? @map("llm_provider") // "ollama" | "openai" | "anthropic"

  // User context (optional - anonymous allowed)
  userId    String? @map("user_id") @db.Uuid
  email     String?
  ipAddress String? @map("ip_address")

  // Timing
  embeddingTimeMs Int? @map("embedding_time_ms")
  searchTimeMs    Int? @map("search_time_ms")
  llmTimeMs       Int? @map("llm_time_ms")
  totalTimeMs     Int? @map("total_time_ms")

  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  // Relations
  feedbacks       QueryFeedback[]
  answerLibraries AnswerLibrary[] @relation("SourceQuery")

  @@index([userId])
  @@index([createdAt])
  @@map("ask_queries")
}

// ============================================================================
// ASKSPM ANSWER LIBRARY & FEEDBACK
// ============================================================================

model AnswerLibrary {
  id              String                      @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  queryText       String                      @map("query_text") @db.Text
  queryEmbedding  Unsupported("vector(768)")? @map("query_embedding")
  normalizedQuery String?                     @map("normalized_query") @db.Text // lowercase, trimmed
  answerText      String                      @map("answer_text") @db.Text
  sourcesJson     Json?                       @map("sources_json")
  confidenceScore Decimal                     @default(1.0) @map("confidence_score") @db.Decimal(3, 2)
  thumbsUpCount   Int                         @default(0) @map("thumbs_up_count")
  thumbsDownCount Int                         @default(0) @map("thumbs_down_count")
  useCount        Int                         @default(1) @map("use_count")
  lastUsedAt      DateTime?                   @map("last_used_at") @db.Timestamptz(6)
  sourceQueryId   String?                     @map("source_query_id") @db.Uuid
  sourceQuery     AskQuery?                   @relation("SourceQuery", fields: [sourceQueryId], references: [id])
  embeddingModel  String?                     @map("embedding_model")
  llmModel        String?                     @map("llm_model")
  llmProvider     String?                     @map("llm_provider")
  isActive        Boolean                     @default(true) @map("is_active")
  createdAt       DateTime                    @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt       DateTime                    @updatedAt @map("updated_at") @db.Timestamptz(6)

  feedbacks QueryFeedback[]

  @@index([sourceQueryId])
  @@index([isActive])
  @@index([lastUsedAt])
  @@map("answer_library")
}

model QueryFeedback {
  id              String         @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  queryId         String         @map("query_id") @db.Uuid
  query           AskQuery       @relation(fields: [queryId], references: [id])
  answerLibraryId String?        @map("answer_library_id") @db.Uuid
  answerLibrary   AnswerLibrary? @relation(fields: [answerLibraryId], references: [id])
  feedbackType    String         @map("feedback_type") // 'thumbs_up' | 'thumbs_down'
  feedbackText    String?        @map("feedback_text") @db.Text
  userId          String?        @map("user_id") @db.Uuid
  email           String?
  ipAddress       String?        @map("ip_address")
  createdAt       DateTime       @default(now()) @map("created_at") @db.Timestamptz(6)

  @@index([queryId])
  @@index([answerLibraryId])
  @@index([feedbackType])
  @@index([createdAt])
  @@map("query_feedback")
}

model ConversationSession {
  id           String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  sessionToken String    @unique @map("session_token")
  messagesJson Json?     @map("messages_json")
  userId       String?   @map("user_id") @db.Uuid
  expiresAt    DateTime? @map("expires_at") @db.Timestamptz(6)
  createdAt    DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt    DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)

  @@index([userId])
  @@index([expiresAt])
  @@map("conversation_sessions")
}
